
## Описание проекта
Данный код реализует внешний алгоритм сортировки для больших файлов, которые не помещаются в оперативную память. Он использует сортировку слиянием (merge sort) и распределяет работу между потоками для повышения производительности.
 В проекте можно генерировать файл `input_transactions`, настраивать его размер, а также задавать размер чанков для обработки.

## Структура файлов
- **generate_transactions_file.rb** — скрипт для генерации файла `input_transactions`, содержащего данные транзакций. Поддерживает настройку размеров файла для гибкости в работе с разными объёмами данных.
- **external_sort.rb** — основной скрипт для сортировки транзакций. Позволяет регулировать размер чанков, что полезно для обработки больших файлов, не помещающихся в оперативную память.
-  **spec/** — содержит тесты для проверки корректности работы генерации и сортировки.

## 1 ШАГ: Генерация транзакций
Чтобы сгенерировать файл `input_transactions`, выполните команду:

```bash
ruby generate_transactions_file.rb
```

Вы можете изменить размер генерируемого файла, указав желаемое количество записей в качестве аргумента. Например:

```ruby
# в файле /generate_transactions_file.rb
generate_transactions_file_size('input_transactions.txt', 0.1) # сгенерируется файл размером 100МБ 
```

## 2 ШАГ: Сортировка транзакций

Этот скрипт **JRuby** реализует **внешнюю сортировку** больших файлов транзакций, которые не помещаются целиком в оперативную память. Внешняя сортировка используется для обработки и сортировки очень больших объемов данных, разделяя их на более мелкие части (чанки), сортируя каждый чанк отдельно с использованием собственного алгоритма сортировки слиянием (`merge_sort`), а затем сливая отсортированные чанки в один итоговый файл.

#### Особенности

- **Обработка больших файлов:** Способен сортировать файлы размером, превышающим объем доступной оперативной памяти.
- **Параллельная обработка:** Использует многопоточность для ускорения процесса сортировки чанков.
- **Настраиваемые параметры:** Позволяет пользователю самостоятельно задавать размер чанков и количество одновременно работающих потоков.
- **Собственный алгоритм сортировки:** Использует самописный алгоритм `merge_sort` для сортировки чанков.
- **Генерация временных файлов:** Автоматически создает и удаляет временные файлы для хранения отсортированных чанков.

#### Требования

- **JRuby:** Версия 9.2 или выше.

#### Запуск скрипта сортировки

```bash
jruby external_sort.rb [опции]

# запуск с использованием значений по умолчанию:
jruby external_sort.rb
```

##### Пример запуска с параметрами по умолчанию:
```bash
/1.sorted_transactions$ jruby external_sort.rb

Запуск программы с параметрами:
Размер чанка по умолчанию: 50 МБ
Количество потоков по умолчанию: 16
Чанк 0: Обработан и сохранён
Чанк 1: Обработан и сохранён
Чанк 2: Обработан и сохранён
Чанк 3: Обработан и сохранён
Чанк 4: Обработан и сохранён
Чанк 5: Обработан и сохранён
Чанк 6: Обработан и сохранён
Чанк 7: Обработан и сохранён
Чанк 8: Обработан и сохранён
Чанк 9: Обработан и сохранён
Чанк 10: Обработан и сохранён
Чанк 11: Обработан и сохранён
Чанк 12: Обработан и сохранён
Чанк 13: Обработан и сохранён
Чанк 14: Обработан и сохранён
Чанк 15: Обработан и сохранён
Чанк 16: Обработан и сохранён
Чанк 20: Обработан и сохранён
Чанк 17: Обработан и сохранён
Чанк 18: Обработан и сохранён
Чанк 19: Обработан и сохранён
Общее время создания и сортировки чанков: 23.7064 секунд
Время слияния чанков: 42.1707 секунд
Время слияния чанков: 42.1713 секунд
Временные файлы удалены
Общее время выполнения: 66.0542 секунд
```

#### Опции
- `-i`  
  **Описание:** Путь к входному файлу с транзакциями.  
  **Пример:** `-i input_transactions.txt`

- `-o`  
  **Описание:** Путь к выходному файлу для записи отсортированных транзакций.  
  **Пример:** `-o sorted_transactions.txt`

- `-c`  
  **Описание:** Размер чанка в мегабайтах. Определяет, сколько данных будет обрабатываться за один раз.  
  **Значение по умолчанию:** `50` МБ  
  **Пример:** `-c 20` (устанавливает размер чанка в 20 МБ)

- `-t`  
  **Описание:** Количество одновременно работающих потоков.  
  **Значение по умолчанию:** Количество доступных процессоров на системе (`Etc.nprocessors`)  
  **Пример:** `-t 4` (устанавливает количество потоков в 4)
  

*После работы скрипта external_sort.rb будет создан файл `sorted_transactions.txt`*


## Как это работает

1. **Вычисление среднего размера строки:**

   Скрипт анализирует первые `1000` строк входного файла, чтобы определить средний размер строки в байтах. Это помогает оценить, сколько строк помещается в один чанк заданного размера.

2. **Разбиение файла на чанки:**

   Входной файл читается последовательно и разбивается на чанки фиксированного размера (по умолчанию `50` МБ). Каждый чанк представляет собой подмножество транзакций.

3. **Параллельная сортировка чанков:**

   Каждый чанк обрабатывается в отдельном потоке:
   - **Сортировка:** Транзакции в чанке сортируются по сумме (`amount`) с использованием собственного алгоритма `merge_sort`.
   - **Запись:** Отсортированные транзакции записываются во временный файл с уникальным именем.

   Количество одновременно работающих потоков ограничивается заданным параметром или количеством доступных процессоров, чтобы избежать переполнения памяти.

4. **Слияние отсортированных чанков:**

   После сортировки всех чанков происходит их слияние:
   - Открываются все временные файлы.
   - Используется максимальная куча (`MaxHeap`) для эффективного слияния транзакций из разных файлов.
   - Итоговые отсортированные транзакции записываются в выходной файл.

5. **Очистка:**

   Все временные файлы и директория для временных файлов удаляются, освобождая место на диске.
   
   
## Управление объемом памяти и производительностью

Вы можете самостоятельно управлять потреблением памяти и производительностью скрипта, настраивая следующие параметры:

1. **Размер чанка (`--chunk-size`):**

   - **Меньший размер чанка:** Снижает потребление памяти, но увеличивает количество временных файлов и время слияния.
   - **Больший размер чанка:** Увеличивает потребление памяти, но снижает количество временных файлов и ускоряет процесс слияния.

   **Рекомендации:**
   - Для систем с ограниченной оперативной памятью используйте меньший размер чанка (например, `10` МБ).
   - Для систем с достаточным объемом памяти можно увеличить размер чанка до `100` МБ или больше.

2. **Количество потоков (`--threads`):**

   - **Меньшее количество потоков:** Снижает потребление памяти и нагрузку на процессор, но увеличивает общее время сортировки.
   - **Большое количество потоков:** Увеличивает использование процессорных ресурсов и может ускорить сортировку, но требует больше памяти.

   **Рекомендации:**
   - Обычно количество потоков равное количеству доступных процессоров (`Etc.nprocessors`) является оптимальным.
   - Если возникают проблемы с памятью, уменьшите количество потоков.
   
#### Пример настройки

Если у вас система с `4` ядрами процессора и `8` ГБ оперативной памяти, вы можете запустить скрипт с размером чанка `20` МБ и `4` потоками:

```bash
jruby external_sort.rb -i input_transactions.txt -o sorted_transactions.txt -c 20 -t 4
```


## Тестирование
Все тесты расположены в директории `spec`. Чтобы запустить тесты, выполните команду:

```bash
rspec spec
```
